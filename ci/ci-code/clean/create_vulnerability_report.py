#!/usr/bin/env python3
import sys
import json
import uuid
import jsonschema


def convert_vulnerability_report_to_gitlab(security_report):
    gitlab_report = {
        "version": "2.0.0",
        "scan": {
            "scanner": {
                "id": "trivy",
                "name": "Trivy",
                "url": "https://github.com/aquasecurity/trivy/",
                "vendor": {"name": "GitLab"},
                "version": "0.26.0",
            },
            "analyzer": {
                "id": "gcs",
                "name": "GitLab Container Scanning",
                "vendor": {"name": "GitLab"},
                "version": "5.1.0",
            },
            "type": "container_scanning",
            "start_time": "2022-05-19T12:47:33",
            "end_time": "2022-05-19T12:47:42",
            "status": "success",
        },
        "vulnerabilities": [],
    }

    for cve, vulnerability in security_report.items():
        severity = vulnerability.get("Severity", "Unknown")
        gitlab_vuln = {
            "id": str(uuid.uuid4()),
            "category": "container_scanning",
            "message": vulnerability.get("Title") or cve,
            "description": "TODO",
            "severity": vulnerability.get("Severity", "Unknown").capitalize(),
            "confidence": "High",
            "scanner": {"id": "trivy", "name": "Trivy"},
            "location": {
                "dependency": {
                    "package": {"name": vulnerability.get("PkgName")},
                    "version": vulnerability.get("InstalledVersion"),
                },
                "operating_system": "TODO",
                "image": ";".join(vulnerability.get("Modules", ["unknown"])),
            },
            "identifiers": [
                {
                    "type": "cve",
                    "name": cve,
                    "value": cve,
                }
            ],
        }
        gitlab_report["vulnerabilities"].append(gitlab_vuln)

    return gitlab_report


def main():
    if len(sys.argv) < 2:
        print(
            "Usage: convert_trivy_to_gitlab.py <vulnerability-report-json-file> <output-json-file>",
            file=sys.stderr,
        )
        sys.exit(1)

    input_path = sys.argv[1]
    output_path = sys.argv[2] if len(sys.argv) > 2 else "gl-container-report.json"
    try:
        with open(input_path, "r") as f:
            trivy_data = json.load(f)
    except FileNotFoundError:
        print(f"INFO - No security file was found at {input_path}!")
        trivy_data = {}

    gitlab_data = convert_vulnerability_report_to_gitlab(trivy_data)

    with open("container-scanning-report-format.json", "r") as f:
        schema = json.load(f)
    try:
        jsonschema.validate(instance=gitlab_data, schema=schema)
    except jsonschema.ValidationError:
        print(f"ERROR - Report does not satisfy json schema! {gitlab_data}")

    with open(output_path, "w") as f:
        json.dump(gitlab_data, f, indent=2)


if __name__ == "__main__":
    main()
