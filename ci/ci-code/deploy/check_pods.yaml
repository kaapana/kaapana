- hosts: "{{ ansible_groupname | default('kaapana_depl_server') }}"
  gather_facts: true
  become: no
  remote_user: "{{ lookup('ansible.builtin.env', 'DEPLOYMENT_INSTANCE_USER') }}"

  tasks:
  - name: Install required system packages
    become: yes
    ansible.builtin.apt: name={{ item }} state=latest update_cache=yes
    loop:
      [
        "python3-pip",
        "python3-venv"
      ]

  - name: Ensure python virtualenv exists in user home
    become: no
    ansible.builtin.command:
      cmd: python3 -m venv "{{ ansible_env.HOME }}/venv"
    args:
      creates: "{{ ansible_env.HOME }}/venv/bin/activate"

  - name: Upgrade pip/setuptools/wheel in venv
    become: no
    ansible.builtin.command: "{{ ansible_env.HOME }}/venv/bin/pip install --upgrade pip setuptools wheel"

  - name: Install python user requirements into venv
    become: no
    ansible.builtin.pip:
      name:
        - kubernetes==32.0.1
      state: present
      virtualenv: "{{ ansible_env.HOME }}/venv"
      virtualenv_command: python3 -m venv
      # Do not set `executable` when `virtualenv` is used; they are mutually exclusive.

  - name: Set Python interpreter to venv python for subsequent tasks
    become: no
    ansible.builtin.set_fact:
      ansible_python_interpreter: "{{ ansible_env.HOME }}/venv/bin/python"

  - name: Reset connection so Ansible uses the new interpreter
    meta: reset_connection

  - debug: 
      msg: "Wait for pods"
  - name: namespace admin
    vars:
      k8s_namespace: "admin"
    ansible.builtin.import_tasks: tasks/check_pods_in_namespace.yaml
  - name: namespace services
    vars:
      k8s_namespace: "services"
    ansible.builtin.import_tasks: tasks/check_pods_in_namespace.yaml
  - name: namespace jobs
    vars:
      k8s_namespace: "jobs"
    ansible.builtin.import_tasks: tasks/check_pods_in_namespace.yaml