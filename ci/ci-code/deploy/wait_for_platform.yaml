- hosts: "{{ ansible_groupname | default('kaapana_depl_server') }}"
  gather_facts: true
  become: no
  remote_user: "{{ lookup('ansible.builtin.env', 'DEPLOYMENT_INSTANE_USER') }}"
  
  tasks:
  - name: Install required system packages
    become: yes
    ansible.builtin.apt: name={{ item }} state=latest update_cache=yes
    loop:
      [
        "python3-pip",
        "python3-venv"
      ]

  - name: Ensure python virtualenv exists in user home
    become: no
    ansible.builtin.command:
      cmd: python3 -m venv "{{ ansible_env.HOME }}/venv"
    args:
      creates: "{{ ansible_env.HOME }}/venv/bin/activate"

  - name: Upgrade pip/setuptools/wheel in venv
    become: no
    ansible.builtin.command: "{{ ansible_env.HOME }}/venv/bin/pip install --upgrade pip setuptools wheel"

  - name: Install python user requirements into venv
    become: no
    ansible.builtin.pip:
      name:
        - kubernetes==32.0.1
      state: present
      virtualenv: "{{ ansible_env.HOME }}/venv"
      virtualenv_command: python3 -m venv
      # Do not set `executable` when `virtualenv` is used; they are mutually exclusive.

  - name: Set Python interpreter to venv python for subsequent tasks
    become: no
    ansible.builtin.set_fact:
      ansible_python_interpreter: "{{ ansible_env.HOME }}/venv/bin/python"

  - name: Reset connection so Ansible uses the new interpreter
    meta: reset_connection

  - name: Wait for job create-project-user
    kubernetes.core.k8s_info:
      kind: Job
      wait: yes
      wait_condition:
        reason: "CompletionsReached"
        status: "True"
        type: "Complete"
      name: "create-project-user"
      namespace: project-admin
      wait_sleep: 10
      wait_timeout: 600

  - debug: 
      msg: "Wait for deployments"
  # - name: namespace admin
  #   vars:
  #     k8s_namespace: "admin"
  #     retry_count: 0
  #   ansible.builtin.import_tasks: tasks/wait_for_deployments.yaml
  - name: namespace services
    vars:
      k8s_namespace: "services"
      retry_count: 0
    ansible.builtin.import_tasks: tasks/wait_for_deployments.yaml

  - debug: 
      msg: "Wait for jobs"
  - name: namespace admin
    vars:
      k8s_namespace: "admin"
      retry_count: 0
    ansible.builtin.import_tasks: tasks/wait_for_jobs.yaml
  - name: namespace services
    vars:
      k8s_namespace: "services"
      retry_count: 0
    ansible.builtin.import_tasks: tasks/wait_for_jobs.yaml