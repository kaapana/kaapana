default:
  tags:
    - shell
    - ci
    - kaapana
  interruptible: true

stages:
  - deploy
  - test

workflow:
  rules:
    - when: always

platform_deployment:
  stage: deploy
  script:
    - source /home/$USER/venv/bin/activate
    - ansible-playbook $REPO_DIR/ci-code/deploy/deploy_platform.yaml --extra-vars "ansible_groupname=$DEPLOYMENT_INSTANCE_NAME"
  artifacts: ### Save environment such that upcoming tasks can depend on this task and have all variables available
    reports:
      dotenv: prepare.env
  retry: 1

#############################################
############## TESTS ########################
#############################################
first_login:
  stage: test
  script:
    - source /home/$USER/venv/bin/activate
    - ansible-playbook $REPO_DIR/ci-code/test/get_client_secret.yaml --extra-vars "ansible_groupname=$DEPLOYMENT_INSTANCE_NAME"
    - ansible-playbook $REPO_DIR/ci-code/test/jobs/ui_tests/first_login.yaml
  artifacts: ### Save environment such that upcoming tasks can depend on this task and have all variables available
    reports:
      dotenv: prepare.env
  rules:
    - if: $TEST_STAGE == "true"
      when: on_success
    - when: never

send_testdata:
  stage: test
  script:
    - source /home/$USER/venv/bin/activate 
    - ansible-playbook $REPO_DIR/ci-code/test/jobs/testdata/prepare_data.yaml --extra-vars "ansible_groupname=$DEPLOYMENT_INSTANCE_NAME"
  needs:
    - first_login
  allow_failure: false
  rules:
    - if: $TEST_STAGE == "true"
      when: on_success
    - when: never
  retry: 2

install_extensions:
  stage: test
  script:
    - source /home/$USER/venv/bin/activate
    - cd $REPO_DIR/ci-code/test/src
    - python3 install_extensions.py --host $ip_address --install-all --log-file $ARTIFACTS_DIR/install_extensions.log --timeout 600
  needs:
    - first_login
  allow_failure: false
  rules:
    - if: $TEST_STAGE == "true"
      when: on_success
    - when: never
  retry: 2

integration_tests:
  stage: test
  script:
    - python3 -m virtualenv $KAAPANA_DIR/ci/.ci
    - source $KAAPANA_DIR/ci/.ci/bin/activate
    - python3 -m pip install -r $KAAPANA_DIR/ci/ci-code/test/src/requirements.txt
    - export test_files=$( find ${KAAPANA_DIR}/data-processing -wholename *ci-config/*.yaml)
    - pytest $KAAPANA_DIR/ci/ci-code/test/src/test_workflows.py --files ${test_files} --host ${ip_address} --junitxml=workflow_test_report.xml -n 4
  artifacts:
    when: always
    paths:
    - workflow_test_report.xml
    reports:
      junit: 
        - workflow_test_report.xml
  needs:
    - first_login
    - send_testdata
    - install_extensions
  allow_failure: true
  rules:
    - if: $TEST_STAGE == "true"
      when: on_success
    - when: never

port_scan:
  stage: test
  script:
    - source /home/$USER/venv/bin/activate 
    - python3 $REPO_DIR/ci-code/test/src/scan_ports.py
  variables:
    ALLOWED_PORTS: "22,80,443"
