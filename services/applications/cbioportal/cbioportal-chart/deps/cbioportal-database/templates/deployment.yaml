apiVersion: apps/v1
kind: Deployment
metadata:
  name: cbioportal-database
  namespace: "{{ .Values.global.services_namespace }}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app-name: cbioportal-database
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app-name: cbioportal-database
    spec:
      containers:
      - name: cbioportal-database-container
        image: "{{ .Values.global.registry_url }}/mysql-5.7:{{ .Values.global.kaapana_build_version }}"
        imagePullPolicy: {{ .Values.global.pull_policy_images }}
        env: # Environment variables
        - name: MYSQL_DATABASE
          value: "cbioportal"
        - name: MYSQL_USER
          value: "cbiouser"
        - name: MYSQL_PASSWORD
          value: "somepassword"
        - name: MYSQL_ROOT_PASSWORD
          value: "somepassword"
        # command: ["echo"]
        # args: ["$(MYSQL_DATABASE)", "$(MYSQL_USER)", "$(MYSQL_PASSWORD)", "$(MYSQL_ROOT_PASSWORD)"]
        ports: # Port(s) on which your application runs
          - containerPort: 3306 # TODO: does it need to???
        resources:
          limits:
            memory: "5Gi"
          requests:
            memory: "300Mi"
        volumeMounts:
          - name: cbioportal-mysql-data # key of volume mount
            mountPath: "/var/lib/mysql" # path in container
          - name: cbioportal-mysql
            mountPath: "/docker-entrypoint-initdb.d/cgds.sql"
            subPath: "cgds.sql"
          - name: cbioportal-mysql
            mountPath: "/docker-entrypoint-initdb.d/seed.sql.gz" 
            subPath: "seed.sql.gz"
      volumes:
        - name: cbioportal-mysql-data 
          persistentVolumeClaim: # named volume without specific host path. Not 100% sure how to realise this in k8s but thiss seems reasonable.
            claimName: cbioportal-pv-claim
        - name: cbioportal-mysql
          hostPath:
            path: "/home/kaapana/cbioportal/data"
            type: Directory