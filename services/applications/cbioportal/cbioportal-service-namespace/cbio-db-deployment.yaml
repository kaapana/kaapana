---
apiVersion: apps/v1
kind: Deployment
metadata:
  # This name uniquely identifies the Deployment
  name: cbioportal-database
  namespace: "services"
spec:
  replicas: 1
  selector:
    matchLabels:
      app-name: cbioportal-database
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app-name: cbioportal-database
    spec:
      containers:
      - name: cbioportal-database-container
        image: "mysql:5.7"
        imagePullPolicy: Always
        env: # Environment variables
        - name: MYSQL_DATABASE
          value: "cbioportal"
        - name: MYSQL_USER
          value: "cbiouser"
        - name: MYSQL_PASSWORD
          value: "somepassword"
        - name: MYSQL_ROOT_PASSWORD
          value: "somepassword"
        # command: ["echo"]
        # args: ["$(MYSQL_DATABASE)", "$(MYSQL_USER)", "$(MYSQL_PASSWORD)", "$(MYSQL_ROOT_PASSWORD)"]
        ports: # Port(s) on which your application runs
          - containerPort: 3306 # TODO: does it need to???
        resources:
          limits:
            memory: "5Gi"
          requests:
            memory: "300Mi"
        volumeMounts:
          - name: cbioportal-mysql-data # key of volume mount
            mountPath: "/var/lib/mysql" # path in container
          - name: cbioportal-mysql
            mountPath: "/docker-entrypoint-initdb.d/cgds.sql"
            subPath: "cgds.sql"
          - name: cbioportal-mysql
            mountPath: "/docker-entrypoint-initdb.d/seed.sql.gz" 
            subPath: "seed.sql.gz"
      volumes:
        - name: cbioportal-mysql-data 
          persistentVolumeClaim: # named volume without specific host path. Not 100% sure how to realise this in k8s but thiss seems reasonable.
            claimName: cbioportal-pv-claim
        - name: cbioportal-mysql
          hostPath:
            path: "/home/kaapana/cbioportal/data"
            type: Directory
        # - name: cbioportal-mysql-cgds
        #   hostPath:
        #     path: "/home/kaapana/cbioportal/data/cgds.sql"
        #     type: File
      # - name: cbioportal-mysql-seed
      # # TODO: networks: cbio-net
      # - name: cbioportal-mysql-cgds

---
apiVersion: v1
kind: Service
metadata:
  name: cbioportal-database
  namespace: "services"
  labels:
    app-name: cbioportal-database
spec:
  selector:
    app-name: cbioportal-database
  ports:
    - port: 3306
      targetPort: 3306
# spec:
#   selector:
#     app-name: cbioportal-database
#   ports:
#     - port: 3306
#       targetPort: 33060
#       nodePort: 3306 # only for development!

  type: ClusterIP
  # type: NodePort
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cbioportal-pv-claim
  namespace: "services"
spec:
  storageClassName: "host-dir" 
  # volumeName: cbioportal-pv-volume
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: "1Gi"
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: cbioportal-pv-volume
  namespace: "services"
  labels:
    type: local
spec:
  storageClassName: "host-dir"
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: "/mnt/cbio-db-mysql/"
