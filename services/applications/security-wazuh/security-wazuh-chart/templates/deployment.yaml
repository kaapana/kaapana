---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: security-wazuh
  namespace: {{ .Values.global.security_namespace }}
  labels:
    k8s-app: security-wazuh
spec:
  replicas: 1
  selector:
    matchLabels:
      app-name: security-wazuh
  template:
    metadata:
      labels:
        app-name: security-wazuh
    spec:
      hostAliases:
      - ip: 0.0.0.0
        hostnames:
        - "wazuh.manager"
        - "wazuh.indexer"
        - "wazuh.dashboard"
      initContainers:
        - name: init-security-wazuh
          image: "{{ .Values.global.registry_url }}/security-wazuh-init:{{ .Values.global.kaapana_build_version  }}"
          imagePullPolicy: {{ .Values.global.pull_policy_jobs }}
          resources: {}
          volumeMounts:
            - mountPath: /wazuh-config
              name: security-wazuh-volume
            - mountPath: /api_credentials
              name: security-wazuh-api-volume
            - mountPath: /wazuh_api_secret
              name: api-credentials-secret
            - mountPath: /wazuh-agent-config
              name: security-wazuh-volume
              subPath: wazuh_etc
      containers:
      - name: security-wazuh-manager
        image: "{{ .Values.global.registry_url }}/security-wazuh-manager:{{ .Values.global.kaapana_build_version  }}"
        imagePullPolicy:  {{ .Values.global.pull_policy_pods }}
        lifecycle:
          postStart:
            exec:
              command: ["/bin/sh", "-c", "curl -H 'Content-Type: application/json' -d '{\"name\": \"Wazuh\", \"url\": \"https://{{ .Values.global.hostname }}/{{ .Values.ingress_path }}\", \"api_endpoints\": [{\"identifier\": \"api\", \"endpoint\":\"https://{{ .Values.service_name }}.services.svc:{{ .Values.wazuh_api_port }}/\"}, {\"identifier\": \"elastic_api\", \"endpoint\":\"https://{{ .Values.service_name }}.services.svc:{{ .Values.wazuh_elastic_api_port }}/\"}]}' -X PUT http://security-pages-service.services.svc:5000/api/providers --insecure"]
        ports:
          - containerPort: 1514
          - containerPort: 1515
          - containerPort: 514
            protocol: UDP
          - containerPort: 55000
        env:
          - name: API_PASSWORD
            valueFrom:
              secretKeyRef:
                name: wazuh-api-credentials
                key: password
          - name: API_USERNAME
            valueFrom:
              secretKeyRef:
                name: wazuh-api-credentials
                key: username
          - name: FILEBEAT_SSL_VERIFICATION_MODE
            value: full
          - name: INDEXER_PASSWORD
            value: SecretPassword
          - name: INDEXER_URL
            value: https://wazuh.indexer:9200
          - name: INDEXER_USERNAME
            value: admin
          - name: SSL_CERTIFICATE
            value: /etc/ssl/filebeat.pem
          - name: SSL_CERTIFICATE_AUTHORITIES
            value: /etc/ssl/root-ca.pem
          - name: SSL_KEY
            value: /etc/ssl/filebeat.key
          - name: "HTTP_PROXY"
            value: {{ .Values.global.http_proxy }}
          - name: "HTTPS_PROXY"
            value: {{ .Values.global.http_proxy }}
          - name: "NO_PROXY"
            value: "svc,local,wazuh.manager,wazuh.indexer,wazuh.dashboard"
        resources:
          limits:
            memory: "8Gi"
          requests:
            memory: "4Gi"
        volumeMounts:
          - mountPath: /var/ossec/api/configuration
            name: security-wazuh-volume
            subPath: wazuh_api_configuration
          - mountPath: /var/ossec/etc
            name: security-wazuh-volume
            subPath: wazuh_etc
          - mountPath: /var/ossec/logs
            name: security-wazuh-volume
            subPath: wazuh_logs
          - mountPath: /var/ossec/queue
            name: security-wazuh-volume
            subPath: wazuh_queue
          - mountPath: /var/ossec/var/multigroups
            name: security-wazuh-volume
            subPath: wazuh_var_multigroups
          - mountPath: /var/ossec/integrations
            name: security-wazuh-volume
            subPath: wazuh_integrations
          - mountPath: /var/ossec/active-response/bin
            name: security-wazuh-volume
            subPath: wazuh_active_response
          - mountPath: /var/ossec/agentless
            name: security-wazuh-volume
            subPath: wazuh_agentless
          - mountPath: /var/ossec/wodles
            name: security-wazuh-volume
            subPath: wazuh_wodles
          - mountPath: /etc/filebeat
            name: security-wazuh-volume
            subPath: filebeat_etc
          - mountPath: /var/lib/filebeat
            name: security-wazuh-volume
            subPath: filebeat_var
          - mountPath: /etc/ssl/root-ca.pem
            name: security-wazuh-volume
            subPath: config/wazuh_indexer_ssl_certs/root-ca-manager.pem
          - mountPath: /etc/ssl/filebeat.pem
            name: security-wazuh-volume
            subPath: config/wazuh_indexer_ssl_certs/wazuh.manager.pem
          - mountPath: /etc/ssl/filebeat.key
            name: security-wazuh-volume
            subPath: config/wazuh_indexer_ssl_certs/wazuh.manager-key.pem
          - mountPath: /wazuh-config-mount/etc/ossec.conf
            name: security-wazuh-volume
            subPath: config/wazuh_cluster/wazuh_manager.conf

      - name: security-wazuh-indexer
        image: "{{ .Values.global.registry_url }}/security-wazuh-indexer:{{ .Values.global.kaapana_build_version  }}"
        imagePullPolicy:  {{ .Values.global.pull_policy_pods }}
        env:
          - name: OPENSEARCH_JAVA_OPTS
            value: -Xms512m -Xmx512m
        ports:
          - containerPort: 9200
        resources:
          limits:
            memory: "12Gi"
          requests:
            memory: "6Gi"
        volumeMounts:
          - mountPath: /var/lib/wazuh-indexer
            name: security-wazuh-volume
            subPath: wazuh-indexer-data
          - mountPath: /usr/share/wazuh-indexer/config/certs/root-ca.pem
            name: security-wazuh-volume
            subPath: config/wazuh_indexer_ssl_certs/root-ca.pem
          - mountPath: /usr/share/wazuh-indexer/config/certs/wazuh.indexer.key
            name: security-wazuh-volume
            subPath: config/wazuh_indexer_ssl_certs/wazuh.indexer-key.pem
          - mountPath: /usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem
            name: security-wazuh-volume
            subPath: config/wazuh_indexer_ssl_certs/wazuh.indexer.pem
          - mountPath: /usr/share/wazuh-indexer/config/certs/admin.pem
            name: security-wazuh-volume
            subPath: config/wazuh_indexer_ssl_certs/admin.pem
          - mountPath: /usr/share/wazuh-indexer/config/certs/admin-key.pem
            name: security-wazuh-volume
            subPath: config/wazuh_indexer_ssl_certs/admin-key.pem
          - mountPath: /usr/share/wazuh-indexer/config/opensearch.yml
            name: security-wazuh-volume
            subPath: config/wazuh_indexer/wazuh.indexer.yml
          - mountPath: /usr/share/wazuh-indexer/plugins/opensearch-security/securityconfig/internal_users.yml
            name: security-wazuh-volume
            subPath: config/wazuh_indexer/internal_users.yml
          - mountPath: /usr/share/wazuh-indexer/plugins/opensearch-security/securityconfig/config.yml
            name: security-wazuh-volume
            subPath: config/wazuh_indexer/security_config.yml
          - mountPath: /usr/share/wazuh-indexer/plugins/opensearch-security/securityconfig/roles_mapping.yml 
            name: security-wazuh-volume
            subPath: config/wazuh_indexer/roles_mapping.yml


      - name: security-wazuh-dashboard
        image: "{{ .Values.global.registry_url }}/security-wazuh-dashboard:{{ .Values.global.kaapana_build_version  }}"
        imagePullPolicy:  {{ .Values.global.pull_policy_pods }}
        ports:
          - containerPort: 5601
        resources:
          limits:
            memory: "8Gi"
          requests:
            memory: "4Gi"
        volumeMounts:
          - mountPath: /usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem
            name: security-wazuh-volume
            subPath: config/wazuh_indexer_ssl_certs/wazuh.dashboard.pem
          - mountPath: /usr/share/wazuh-dashboard/certs/wazuh-dashboard-key.pem
            name: security-wazuh-volume
            subPath: config/wazuh_indexer_ssl_certs/wazuh.dashboard-key.pem
          - mountPath: /usr/share/wazuh-dashboard/certs/root-ca.pem
            name: security-wazuh-volume
            subPath: config/wazuh_indexer_ssl_certs/root-ca.pem
          - mountPath: /usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
            name: security-wazuh-volume
            subPath: config/wazuh_dashboard/opensearch_dashboards.yml
          - mountPath: /usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml
            name: security-wazuh-volume
            subPath: config/wazuh_dashboard/wazuh.yml
      imagePullSecrets:
      - name: registry-secret
      volumes:
        - name: security-wazuh-volume
          persistentVolumeClaim:
            claimName: security-wazuh-persistent-volume-claim
        - name: security-wazuh-api-volume
          persistentVolumeClaim:
            claimName: security-wazuh-api-persistent-volume-claim
        - name: api-credentials-secret
          secret:
            secretName: wazuh-api-credentials
