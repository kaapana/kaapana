---
apiVersion: batch/v1
kind: Job
metadata:
  name: update-workflow-api
  namespace: "services"
spec:
  template:
    metadata:
      name: update-workflow-api
    spec:
      # initContainers:
      #   - name: wait-workflow-api
      #     image: "{{ .Values.global.registry_url }}/service-checker:{{ .Values.global.kaapana_build_version  }}"
      #     imagePullPolicy: {{ .Values.global.pull_policy_images }}
      #     env:
      #       - name: DELAY
      #         value: "2"
      #       - name: TIMEOUT
      #         value: "10"
      containers:
      - name: update
        image: "registry.hzdr.de/lorenz.feineis/kaapana-feineis-dev/workflow-api:0.0.0-latest"
        imagePullPolicy:  Always
        command: ["python", "-u"]
        args: ["/app/sync.py"]
        env:
        - name: APPLICATION_ROOT
          value: "/workflow-api"
        - name: DATABASE_URL
          value: "postgresql://kaapanauser:kaapanapassword@workflow-api-database-service.services.svc:5432"
          # value: "postgresql://{{ .Values.kaapana_database.postgres_user}}:{{ .Values.kaapana_database.postgres_password}}@{{ .Values.kaapana_database.appName | default .Chart.Name }}-database-service.{{ .Values.global.services_namespace }}.svc:5432"
        volumeMounts:
        resources:
          requests:
            memory: 100Mi
          limits:
            memory: 500Mi
      restartPolicy: Never
      imagePullSecrets:
      - name: registry-secret
  backoffLimit: 2