apiVersion: v1
kind: ConfigMap
metadata:
  name: airflow-webserver-config
  namespace: "{{ .Values.global.services_namespace }}"
data:
   webserver_config.py: |+
    from flask import get_flashed_messages, request, redirect, flash, url_for
    from flask_appbuilder import expose
    from flask_appbuilder._compat import as_unicode
    from flask_appbuilder.security.views import AuthView
    from airflow.www.fab_security.manager import AUTH_REMOTE_USER
    from flask_login import login_user, logout_user
    from airflow.auth.managers.fab.security_manager.override import FabAirflowSecurityManagerOverride

    class CustomAuthRemoteUserView(AuthView):
        login_template = ""

        @expose("/login/")
        def login(self):
            next_url = request.args.get('next') or self.appbuilder.get_url_for_index
            username = request.headers.get('X-Forwarded-Preferred-Username')
            email = request.headers.get('X-Forwarded-Email')
            
            print(f"Login attempt with username={username}, email={email}, next_url={next_url}")

            if username:
                user = self.appbuilder.sm.auth_user_remote_user(username)
                if user is None:
                    flash(as_unicode(self.invalid_login_message), "warning")
                    print("Invalid login attempt: user not found")
                else:
                    login_user(user)
                    print(f"User {username} logged in successfully")
                    return redirect(next_url)
            else:
                flash(as_unicode(self.invalid_login_message), "warning")
                print("Invalid login attempt: username header missing")

            # Flush "Access is Denied" flash message
            get_flashed_messages()
            return redirect(next_url)

        @expose("/logout/")
        def logout(self):
            logout_user()
            print("User logged out")
            return redirect("/oauth2/sign_out?redirect=/")

    class CustomAirflowSecurityManager(FabAirflowSecurityManagerOverride):
        authremoteuserview = CustomAuthRemoteUserView

    SECURITY_MANAGER_CLASS = CustomAirflowSecurityManager


