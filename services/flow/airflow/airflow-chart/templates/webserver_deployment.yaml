---
#  Licensed to the Apache Software Foundation (ASF) under one   *
#  or more contributor license agreements.  See the NOTICE file *
#  distributed with this work for additional information        *
#  regarding copyright ownership.  The ASF licenses this file   *
#  to you under the Apache License, Version 2.0 (the            *
#  "License"); you may not use this file except in compliance   *
#  with the License.  You may obtain a copy of the License at   *
#                                                               *
#    http://www.apache.org/licenses/LICENSE-2.0                 *
#                                                               *
#  Unless required by applicable law or agreed to in writing,   *
#  software distributed under the License is distributed on an  *
#  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY       *
#  KIND, either express or implied.  See the License for the    *
#  specific language governing permissions and limitations      *
#  under the License.                                           *
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: airflow-webserver
  namespace: "{{ .Values.global.services_namespace }}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app-name: airflow-webserver
  template:
    metadata:
      labels:
        app-name: airflow-webserver
    spec:
      initContainers:
      - name: airflow-scheduler-check
        image: "{{ .Values.global.registry_url }}/service-checker:{{ .Values.global.kaapana_build_version  }}"
        imagePullPolicy: {{ .Values.global.pull_policy_images }}
        env:
        - name: WAIT
          value: "postgres,postgres-airflow,5432;statsd-service,airflow-statsd-service.{{  .Values.global.services_namespace  }}.svc,9102"
        - name: DELAY
          value: "5"
        - name: FILES_AND_FOLDERS_EXISTS
          value: "/kaapana/mounted/workflows/dags/__pycache__"
        volumeMounts:
        - name: airflow-dags
          mountPath: /kaapana/mounted/workflows/dags
      containers:
      - name: webserver
        image: "{{ .Values.global.registry_url }}/airflow:{{ .Values.global.kaapana_build_version  }}"
        imagePullPolicy:  {{ .Values.global.pull_policy_images }}
        ports:
        - name: webserver
          containerPort: 8080
        args: ["webserver"]
        env:
        - name: ADMIN_NAMESPACE
          value: "{{ .Values.global.admin_namespace }}"
        - name: AIRFLOW_HOME
          value: "/kaapana/mounted/workflows"
        - name: AIRFLOW__LOGGING__LOGGING_LEVEL
          value: "WARNING"
        - name: DEFAULT_REGISTRY
          value: "{{ .Values.global.registry_url }}"
        - name: EXTENSIONS_NAMESPACE
          value: "{{ .Values.global.extensions_namespace }}"
        - name: HOSTDOMAIN
          value: "{{ .Values.global.hostname }}"
        - name: HTTPS_PORT
          value: "{{ .Values.global.https_port }}"
        - name: INSTANCE_NAME
          value: "{{ .Values.global.instance_name }}"
        - name: JOBS_NAMESPACE
          value: "{{ .Values.global.jobs_namespace }}"
        - name: KAAPANA_BUILD_VERSION
          value: "{{ .Values.global.kaapana_build_version }}"
        - name: MINIOUSER
          value: "{{ .Values.global.credentials_minio_username }}"
        - name: MINIOPASSWORD
          value: "{{ .Values.global.credentials_minio_password }}"
        - name: PULL_POLICY_IMAGES
          value: "{{ .Values.global.pull_policy_images }}"
        - name: SERVICES_NAMESPACE
          value: "{{ .Values.global.services_namespace }}"
        - name: SQL_ALCHEMY_CONN
          value: postgresql+psycopg2://root:root@postgres-airflow:5432/airflow
        - name: OIDC_CLIENT_SECRET
          value: "{{ .Values.global.oidc_client_secret }}"
        - name: SYSTEM_USER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: system-user-password
              key: system-user-password
        resources:
          requests:
            memory: 600Mi
          limits:
            memory: 3000Mi
        volumeMounts:
        - name: airflow-configmap
          mountPath: /kaapana/mounted/workflows/airflow.cfg
          subPath: airflow.cfg
        - name: airflow-webserver-config
          mountPath: /kaapana/mounted/workflows/webserver_config.py
          subPath: webserver_config.py
        - name: airflow-plugins
          mountPath: /kaapana/mounted/workflows/plugins
        - name: airflow-dags
          mountPath: /kaapana/mounted/workflows/dags
        - name: modeldata
          mountPath: /kaapana/mounted/workflows/models
        - name: airflow-logs
          mountPath: /kaapana/mounted/workflows/logs
        - name: tmp
          mountPath: /kaapana/mounted/workflows/
        - name: tmpfs
          mountPath: /tmp
        securityContext:
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
        # readinessProbe:
        #   initialDelaySeconds: 120
        #   timeoutSeconds: 5
        #   periodSeconds: 5
        #   httpGet:
        #     path: /flow/kaapana/api/getdags
        #     port: 8080
        # livenessProbe:
        #   initialDelaySeconds: 300
        #   periodSeconds: 120
        #   timeoutSeconds: 5
        #   failureThreshold: 5
        #   httpGet:
        #     path: /flow
        #     port: 8080
      volumes:
      - name: airflow-configmap
        configMap:
          name: airflow-configmap
      - name: airflow-webserver-config
        configMap:
          name: airflow-webserver-config
      - name: airflow-dags
        persistentVolumeClaim:
          claimName: dags-pv-claim
      - name: airflow-plugins
        persistentVolumeClaim:
          claimName: af-plugins-pv-claim
      - name: modeldata
        persistentVolumeClaim:
          claimName: models-pv-claim
      - name: airflow-logs
        persistentVolumeClaim:
          claimName: af-logs-pv-claim
      - name: tmp 
        emptyDir: {}
      - name: tmpfs
        emptyDir: {}
      # - name: airflow-statsd-config
      #   configMap:
      #     name: airflow-statsd-config

      # - name: modeldata
      #   persistentVolumeClaim:
      #     claimName: models-pv-claim
      # - name: ctpinput
      #   persistentVolumeClaim:
      #     claimName: ctp-data-pv-claim
      # - name: workflowdata
      #   persistentVolumeClaim:
      #     claimName: af-data-pv-claim
      # - name: dicomdir
      #   persistentVolumeClaim:
      #     claimName: dcm4chee-dicom-pv-claim
      priorityClassName: kaapana-high-priority
      imagePullSecrets:
      - name: registry-secret
---
