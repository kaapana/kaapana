apiVersion: batch/v1
kind: CronJob
metadata:
  name: opensearch-security-backup
  namespace: "{{ .Values.global.services_namespace }}"
spec:
  schedule: "*/1 * * * *"
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 60
      template:
        spec:
          ttlSecondsAfterFinished: 60
          initContainers:
          - name: init
            image: "{{ .Values.global.registry_url }}/service-checker:{{ .Values.global.kaapana_build_version  }}"
            imagePullPolicy:  {{ .Values.global.pull_policy_images }}
            env:
              - name: WAIT
                value: "opensearch,opensearch-service.{{  .Values.global.services_namespace  }}.svc,9200"
              - name: DELAY
                value: "1"
              - name: TIMEOUT
                value: "10"
          containers:
          - name: backup-security-config
            image: "{{ .Values.global.registry_url }}/opensearch:{{ .Values.global.kaapana_build_version  }}"
            imagePullPolicy: {{ .Values.global.pull_policy_images }}
            command: ["/bin/sh","backup-security.sh"]
            resources:
              requests:
                memory: "100Mi"
              limits:
                memory: "500Mi"
            volumeMounts:
              - name: os-security-backup
                mountPath: /kaapana/opensearch-security-backup
              - name: oscerts
                mountPath: /usr/share/opensearch/config/root-ca.pem
                subPath: root-ca.pem
              - name: oscerts
                mountPath: /usr/share/opensearch/config/admin.pem
                subPath: admin.pem
              - name: oscerts
                mountPath: /usr/share/opensearch/config/admin-key.pem
                subPath: admin-key.pem
          volumes:
          - name: os-security-backup
            persistentVolumeClaim:
              claimName: os-security-backup-pv-claim
          - name: oscerts
            persistentVolumeClaim:
              claimName: os-certs-pv-claim
          restartPolicy: Never
          securityContext:
            runAsUser: 1000
          imagePullSecrets:
            - name: registry-secret
          