apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app.kubernetes.io/component: exporter
    app.kubernetes.io/name: node-exporter
  name: node-exporter
  namespace: "{{ .Values.global.services_namespace }}"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/component: exporter
      app.kubernetes.io/name: node-exporter
  template:
    metadata:
      labels:
        app.kubernetes.io/component: exporter
        app.kubernetes.io/name: node-exporter
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9100"
        prometheus.io/path: "/metrics"
        prometheus.io/scheme: "http"
        prometheus.io/custom_job_name: "node-exporter"
        prometheus.io/scrape_interval: "15s"
        prometheus.io/scrape_timeout: "10s"
    spec:
      containers:
      - args:
        - --path.sysfs=/host/sys
        - --path.rootfs=/host/root
        - --no-collector.wifi
        - --no-collector.hwmon
        - --collector.filesystem.ignored-mount-points=^/(dev|proc|sys|var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)
        - --collector.netclass.ignored-devices=^(veth.*)$
        - --collector.textfile.directory=/var/lib/node_exporter/textfile_collector
        name: node-exporter
        image: "{{ .Values.global.registry_url }}/node-exporter:{{ .Values.global.kaapana_build_version  }}"
        imagePullPolicy:  {{ .Values.global.pull_policy_images }}
        ports:
          - containerPort: 9100
            protocol: TCP
        resources:
          limits:
            cpu: 250m
            memory: 180Mi
          requests:
            cpu: 102m
            memory: 180Mi
        volumeMounts:
        - mountPath: /host/sys
          mountPropagation: HostToContainer
          name: sys
          readOnly: true
        - mountPath: /host/root
          mountPropagation: HostToContainer
          name: root
          readOnly: true
        - mountPath: /var/lib/node_exporter/textfile_collector
          name: textfile-collector
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
      - name: custom-node-exporter-textfile-collector
        image: alpine:3.19
        imagePullPolicy: IfNotPresent
        env:
        - name: TEXTFILE_POLL_INTERVAL
          value: "300"
        - name: FAST_PATH
          value: {{ .Values.global.fast_data_dir | quote }}
        - name: SLOW_PATH
          value: {{ .Values.global.slow_data_dir | quote }}
        command:
        - /bin/sh
        - -c
        - |
            set -euo pipefail
            TEXTFILE_DIR="/textfile"
            FAST_DIR="/fast"
            SLOW_DIR="/slow"
            SLEEP_INTERVAL="${TEXTFILE_POLL_INTERVAL:-300}"
            while true; do
                fast_kb=$(du -s "${FAST_DIR}" 2>/dev/null | awk '{print $1}') || fast_kb=0
                fast_bytes=$((fast_kb * 1024))
                fast_kb_total=$(df -kP "${FAST_DIR}" 2>/dev/null | awk 'NR==2 {print $2}') || fast_kb_total=0
                fast_kb_available=$(df -kP "${FAST_DIR}" 2>/dev/null | awk 'NR==2 {print $4}') || fast_kb_available=0
                fast_fs_bytes=$((fast_kb_total * 1024))
                fast_bytes_available=$((fast_kb_available * 1024))

                slow_kb=$(du -s "${SLOW_DIR}" 2>/dev/null | awk '{print $1}') || slow_kb=0
                slow_bytes=$((slow_kb * 1024))
                slow_kb_total=$(df -kP "${SLOW_DIR}" 2>/dev/null | awk 'NR==2 {print $2}') || slow_kb_total=0
                slow_kb_available=$(df -kP "${SLOW_DIR}" 2>/dev/null | awk 'NR==2 {print $4}') || slow_kb_available=0
                slow_fs_bytes=$((slow_kb_total * 1024))
                slow_bytes_available=$((slow_kb_available * 1024))

                printf '%s\n%s\n%s\n' \
                  "# HELP kaapana_fast_dir_size_bytes Size of FAST_DATA_DIR contents in bytes" \
                  "# TYPE kaapana_fast_dir_size_bytes gauge" \
                  "kaapana_fast_dir_size_bytes{path=\"${FAST_PATH}\"} ${fast_bytes}" \
                  > "${TEXTFILE_DIR}/kaapana_fast_size.prom"
                printf '%s\n%s\n%s\n' \
                  "# HELP kaapana_fast_fs_size_bytes Total filesystem capacity backing FAST_DATA_DIR" \
                  "# TYPE kaapana_fast_fs_size_bytes gauge" \
                  "kaapana_fast_fs_size_bytes{path=\"${FAST_PATH}\"} ${fast_fs_bytes}" \
                  >> "${TEXTFILE_DIR}/kaapana_fast_size.prom"
                printf '%s\n%s\n%s\n' \
                  "# HELP kaapana_fast_fs_available_bytes Available filesystem space for FAST_DATA_DIR" \
                  "# TYPE kaapana_fast_fs_available_bytes gauge" \
                  "kaapana_fast_fs_available_bytes{path=\"${FAST_PATH}\"} ${fast_bytes_available}" \
                  >> "${TEXTFILE_DIR}/kaapana_fast_size.prom"

                printf '%s\n%s\n%s\n' \
                  "# HELP kaapana_slow_dir_size_bytes Size of SLOW_DATA_DIR contents in bytes" \
                  "# TYPE kaapana_slow_dir_size_bytes gauge" \
                  "kaapana_slow_dir_size_bytes{path=\"${SLOW_PATH}\"} ${slow_bytes}" \
                  > "${TEXTFILE_DIR}/kaapana_slow_size.prom"
                printf '%s\n%s\n%s\n' \
                  "# HELP kaapana_slow_fs_size_bytes Total filesystem capacity backing SLOW_DATA_DIR" \
                  "# TYPE kaapana_slow_fs_size_bytes gauge" \
                  "kaapana_slow_fs_size_bytes{path=\"${SLOW_PATH}\"} ${slow_fs_bytes}" \
                  >> "${TEXTFILE_DIR}/kaapana_slow_size.prom"
                printf '%s\n%s\n%s\n' \
                  "# HELP kaapana_slow_fs_available_bytes Available filesystem space for SLOW_DATA_DIR" \
                  "# TYPE kaapana_slow_fs_available_bytes gauge" \
                  "kaapana_slow_fs_available_bytes{path=\"${SLOW_PATH}\"} ${slow_bytes_available}" \
                  >> "${TEXTFILE_DIR}/kaapana_slow_size.prom"
                sleep "${SLEEP_INTERVAL}"
            done
        volumeMounts:
        - mountPath: /textfile
          name: textfile-collector
        - mountPath: /fast
          name: kaapana-fast
          readOnly: true
        - mountPath: /slow
          name: kaapana-slow
          readOnly: true
        resources:
          requests:
            memory: 50Mi
          limits:
            memory: 50Mi
        securityContext:
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
      volumes:
      - hostPath:
          path: /sys
        name: sys
      - hostPath:
          path: /
        name: root
      - name: textfile-collector
        emptyDir: {}
      - name: kaapana-fast
        hostPath:
          path: {{ .Values.global.fast_data_dir | quote }}
          type: Directory
      - name: kaapana-slow
        hostPath:
          path: {{ .Values.global.slow_data_dir | quote }}
          type: Directory
      imagePullSecrets:
      - name: registry-secret
      