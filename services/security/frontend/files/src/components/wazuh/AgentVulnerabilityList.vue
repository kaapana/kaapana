
<script setup lang="ts">
import type { IAgentVulnerability } from "@/types/wazuh";
import { defineComponent } from 'vue'
import Group, { EGroupPadding } from "@/components/Group.vue";
import AgentVulnerability from "@/components/wazuh/AgentVulnerability.vue";
import ElementList from "../ElementList.vue";
import { EDirection } from "@/types/enums";
import { EElementListMargin } from "../ElementList.vue";
import { useWazuhStore, type VulnerabilityInformationMap } from '@/stores/wazuh';
import { mapState, mapWritableState } from 'pinia';
</script>

<template>
  <Group v-if="vulnerabilityList === undefined" :alternativeColorScheme="true" :paddingSize=EGroupPadding.SMALL>Loading vulnerabilities...</Group>
  <div v-else-if="vulnerabilityList.size === 0">
    {{ `No vulnerabilities found, either restart agent ${agent_id} manually by executing 'sudo systemctl disable wazuh-agent && sudo systemctl enable wazuh-agent && sudo systemctl start wazuh-agent' on the system it is installed on or wait until the vulnerability scan is triggered again by Wazuh (this can take up to 30 minutes). Vulnerabilities will also not be shown if the Wazuh deployment has no internet access.` }}
  </div>
  <template v-else>
    <ElementList :direction=EDirection.VERTICAL :margin=EElementListMargin.SMALL>
      <template v-for="[vulnerabilityId, vulnerability] of vulnerabilityList">
        <Group :alternativeColorScheme="true">
          <AgentVulnerability :vulnerability="vulnerability"></AgentVulnerability>
        </Group>
      </template>
    </ElementList>
  </template>
</template>

<script lang="ts">
export default defineComponent({
  props: {
    agent_id: {
      type: String,
      required: true
    }
  },
  computed: {
    ...mapWritableState(useWazuhStore, ["vulnerabilityInformation"]),
    ...mapState(useWazuhStore, {
      vulnerabilityList(store) {
        return store.vulnerabilityInformation?.get((this as any).agent_id);
      }
    })
  },
  methods: {
    async getVulnerabilityInformation() {
      if (this.vulnerabilityInformation === null) {
        this.vulnerabilityInformation = new Map();
      }

      const response = await fetch(window.location.origin + `/security/api/providers/wazuh/agents/${this.agent_id}/vulnerabilities`);
      if (response.status !== 200) {
        throw new Error("Unexpected response from backend");
      }
      const json = await response.json();
      if (json["data"] === null) {
        this.vulnerabilityInformation.set(this.agent_id, new Map());
        return;
      }

      const agentVulnerabilityInformation = json["data"].reduce((acc: VulnerabilityInformationMap, vulnerability: IAgentVulnerability) => {
        acc.set(vulnerability.title, vulnerability);
        return acc;
      }, new Map());

      this.vulnerabilityInformation.set(this.agent_id, agentVulnerabilityInformation);
    }
  },
  async mounted() {
    await this.getVulnerabilityInformation();
  }
});
</script>

<style scoped>
</style>