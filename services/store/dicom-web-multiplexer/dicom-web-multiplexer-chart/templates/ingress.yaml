---
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: strip-prefix-dicom-web-filter-multiplexer
  namespace: "{{ .Values.global.services_namespace }}"
spec:
  stripPrefix:
    prefixes:
      - /dicom-web-filter
    forceSlash: true
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: dicom-web-filter-ingressroute
  namespace: "{{ .Values.global.services_namespace }}"
spec:
  entryPoints:
    - websecure
  routes:
    # Match for the query parameter first
    - match: "PathPrefix(`/dicom-web-filter`) && (Query(`AccessDicomWebFilter`, `true`))"
      kind: Rule
      services:
        - name: dicom-web-filter-service  # Forward to the multiplexer service when the query parameter is true
          port: 8080
      middlewares:
        - name: strip-prefix-dicom-web-filter-multiplexer
          namespace: "{{ .Values.global.services_namespace }}"

    - match: PathPrefix(`/dicom-web-filter`)
      kind: Rule
      services:
        - name: dicom-web-multiplexer-service
          port: 8080
      