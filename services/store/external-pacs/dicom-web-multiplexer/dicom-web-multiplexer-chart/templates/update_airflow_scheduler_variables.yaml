apiVersion: batch/v1
kind: Job
metadata:
  name: update-global-variables
  namespace: "{{ .Values.global.services_namespace }}"
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: append-variables
        image: "{{ .Values.global.registry_url }}/update-variables:{{ .Values.global.kaapana_build_version }}"
        imagePullPolicy: "{{ .Values.global.pull_policy_images }}"
        env:
        - name: DICOM_WEB_SERVICE_RS
          value: "http://dicom-web-multiplexer-service.{{ .Values.global.services_namespace }}.svc:8080/dicom-web-filter"
        - name: DICOM_WEB_SERVICE_URI
          value: "http://dicom-web-multiplexer-service.{{ .Values.global.services_namespace }}.svc:8080/dicom-web-filter/wado-uri/wado"
        command:
        - "/app/start.sh"
        - "append"
        volumeMounts:
        - name: airflow-plugins
          mountPath: /kaapana/mounted/workflows/plugins
      volumes:
      - name: airflow-plugins
        persistentVolumeClaim:
          claimName: af-plugins-pv-claim
  backoffLimit: 4
---
apiVersion: batch/v1
kind: Job
metadata:
  name: revert-global-variables
  namespace: "services"
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: update-variables
        image: "{{ .Values.global.registry_url }}/update-variables:{{ .Values.global.kaapana_build_version }}"
        command:
        - "/app/start.sh"
        - "remove"
        volumeMounts:
        - name: airflow-plugins
          mountPath: /kaapana/mounted/workflows/plugins
      volumes:
      - name: airflow-plugins
        persistentVolumeClaim:
          claimName: af-plugins-pv-claim
  backoffLimit: 4
