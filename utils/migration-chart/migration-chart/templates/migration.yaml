---
apiVersion: batch/v1
kind: Job
metadata:
  name: migration
  namespace: "{{ .Values.global.namespace }}"
spec:
  backoffLimit: 0        # Never retry, fail immediately
  template:
    metadata:
      name: migration
    spec:
      restartPolicy: Never
      containers:
      - name: migration
        image: "{{ .Values.global.registry_url }}/migration:{{ .Values.global.kaapana_build_version }}"
        imagePullPolicy: "{{ .Values.global.pull_policy_images }}"
        env:
        - name: FAST_DATA_DIR
          value: "{{ .Values.global.fast_data_dir}}"
        - name: SLOW_DATA_DIR
          value: "{{ .Values.global.slow_data_dir}}"
        - name: FROM_VERSION
          value: "{{ .Values.global.from_version }}"
        - name: TO_VERSION
          value: "{{ .Values.global.to_version }}"
        - name: STORAGE_PROVIDER
          value: "{{ .Values.global.storage_provider }}"
        - name: STORAGE_CLASS_SLOW
          value: "{{ .Values.global.storage_class_slow }}"    
        - name: STORAGE_CLASS_FAST
          value: "{{ .Values.global.storage_class_fast }}"    
        - name: STORAGE_CLASS_WORKFLOW  
          value: "{{ .Values.global.storage_class_workflow }}"
        - name: SERVICES_NAMESPACE
          value: "{{ .Values.global.services_namespace }}"    
        - name: ADMIN_NAMESPACE
          value: "{{ .Values.global.admin_namespace }}"    
        - name: VOLUME_SLOW_DATA
          value: "{{ .Values.global.volume_slow_data }}"
        - name: MIGRATION_IMAGE
          value: "{{ .Values.global.registry_url }}/migration:{{ .Values.global.kaapana_build_version }}"
        volumeMounts:
        - name: fastdir
          mountPath: "{{ .Values.global.fast_data_dir }}"
        {{- if ne .Values.global.fast_data_dir .Values.global.slow_data_dir }}
        - name: slowdir
          mountPath: "{{ .Values.global.slow_data_dir }}"
        {{- end }}
      volumes:
        - name: fastdir
          persistentVolumeClaim:
            claimName: fast-data-dir-pvc
        {{- if ne .Values.global.fast_data_dir .Values.global.slow_data_dir }}
        - name: slowdir
          persistentVolumeClaim:
            claimName: slow-data-dir-pvc
        {{- end }}
      serviceAccountName: kaapana-kube-admin
      imagePullSecrets:
      - name: registry-secret